configfile: "new_config.yml"

REF_OVER = config['ref_overlap_prefix']
CHR = config['chrs']
SV = config['sv_types']

rule all:
	input: expand("../test/{chr}_{sv}_merged.bed", chr=CHR, sv=SV)
#		"../test/annotated_svs.bed"

rule run_SV_merges:
	input:
		"../tests/{CHR}_{SV}.bed" 
	output:
		temp("../tests/{CHR}_{SV}_merged.bed")
	threads: 1
	params:
		runtime="1:00:00",
		mem="1gb",
		chr="{CHR}",
		sv="{SV}"
	shell:
		"""
		sed '1s/^/#/' {input} > {input}_temp
		
		if [[ {params.sv} == "MEIs" ]]
		then
			## This line is to compensate for a previous bug - it currently doesn't write to a file so would need to if used
			## awk 'BEGIN {{OFS="\t"}} {{print {params.chr},$2,$3,$4,$5,$6}}' < ../tests/chr4_MEIs.bed_temp 
			python ../code/merge_MEI.py -i {input}_temp -o {output}
		else
			python sv_merging.py {input}_temp {output}
		fi
		rm {input}_temp
		"""

rule add_filters:
	input:
		sv="../tests/{CHR}_{SV}_merged.bed",
		gnomad="../resources/gnomad_{SV}.bed",
		kg="../resources/1kg_{SV}.bed",
		repeat="../resources/hg19_simpleRepeats_merged.bed"
	output:
		"../tests/{CHR}_{SV}_annotated.bed"
	shell:
		"""
		python ../code/get_overlap.py -i {input.sv} -r {input.gnomad} -o {output}_gnomad
		python ../code/get_overlap.py -i {output}_gnomad -r {input.kg} -o {output}_1kg
		python ../code/get_overlap.py -i {output}_1kg -r {input.repeat} -o {output}
		"""

rule merge_files:
	input:
		expand("../tests/{chr}_{sv}_annotated.bed", chr=CHR, sv=SV)
	output:
		"../tests/annotated_svs.bed"
	shell:
		"""
		cat {input} > {output}
		"""

